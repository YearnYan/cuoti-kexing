<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é”™é¢˜å…‹æ˜Ÿ - èµ›åšå·¥å¤´ç‡•å“¥</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- MathJax -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts (Only for Logo) -->
    <link href="https://fonts.googleapis.com/css2?family=Zcool+XiaoWei&display=swap" rel="stylesheet">

    <style>
        body {
            background-color: #F8FAFC;
            font-family: "Microsoft YaHei", "Heiti SC", sans-serif;
            color: #334155;
        }

        /* -----------------------
           Special UI for Header 
           ----------------------- */
        .header-special {
            background: linear-gradient(135deg, #312E81 0%, #4C1D95 50%, #581C87 100%);
            /* Deep Indigo to Purple */
            border-bottom: 4px solid #F59E0B;
            /* Gold Border */
        }

        .logo-text {
            font-family: 'Zcool XiaoWei', serif;
            color: #FFF;
            text-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3);
            letter-spacing: 2px;
        }

        .btn-load-more {
            background: linear-gradient(to right, #4F46E5, #7C3AED);
            transition: all 0.3s ease;
        }

        .btn-load-more:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 20px -5px rgba(124, 58, 237, 0.4);
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* é¢˜å·å¾½ç«  */
        .q-badge {
            background: #F1F5F9;
            color: #334155;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-weight: bold;
            font-family: sans-serif;
            border: 1px solid #E2E8F0;
            font-size: 14px;
        }

        /* æ‰“å°æ§åˆ¶ - Optimized */
        @media print {
            @page {
                margin: 1cm;
            }

            .no-print {
                display: none !important;
            }

            .print-only {
                display: block !important;
            }

            body,
            main {
                background: white;
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
                box-shadow: none !important;
            }

            .avoid-break {
                break-inside: avoid;
            }
        }

        .print-only {
            display: none;
        }

        /* Print layout tuning for PDF output */
        :root {
            --print-question-gap: 8px;
            --print-question-gap-no-figure: 4px;
            --print-answer-min-height: 26mm;
            --print-answer-min-height-no-figure: 14mm;
            --print-figure-width: 60mm;
            --print-figure-height: 40mm;
            --print-figure-min-width: 45mm;
            --print-figure-min-height: 30mm;
            --print-figure-max-width: 70mm;
            --print-figure-max-height: 50mm;
            --print-figure-min-width-complex: 60mm;
            --print-figure-min-height-complex: 40mm;
            --print-figure-max-width-complex: 90mm;
            --print-figure-max-height-complex: 65mm;
            --print-answer-column-gap: 12px;
        }

        .print-question {
            padding-bottom: var(--print-question-gap);
            margin-bottom: var(--print-question-gap);
            border-bottom: 1px dashed #E5E7EB;
        }

        .print-question.no-figure {
            padding-bottom: var(--print-question-gap-no-figure);
            margin-bottom: var(--print-question-gap-no-figure);
        }

        .print-question:last-child {
            padding-bottom: 0;
            margin-bottom: 0;
            border-bottom: none;
        }

        .print-q-row {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .print-q-number {
            font-weight: bold;
            min-width: 26px;
        }

        .print-q-body {
            flex: 1 1 auto;
        }

        .print-q-text {
            line-height: 1.6;
        }

        .print-stem {
            margin-bottom: 4px;
        }

        .print-subq {
            margin-top: 3px;
            padding-left: 1.4em;
            text-indent: -1.4em;
        }

        .print-answer-area {
            margin-top: 6px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--print-answer-column-gap);
            align-items: center;
            min-height: max(var(--print-answer-min-height), min(var(--print-figure-height), var(--print-figure-max-height)));
        }

        .print-answer-area.no-figure {
            grid-template-columns: 1fr;
            min-height: var(--print-answer-min-height-no-figure);
            margin-top: 4px;
        }

        .print-answer-left {
            min-height: var(--print-answer-min-height);
        }

        .print-answer-lines {
            width: 100%;
            height: 100%;
        }

        .print-answer-right {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: var(--print-figure-height);
        }

        .print-figure {
            width: clamp(var(--print-figure-min-width), var(--print-figure-width), var(--print-figure-max-width));
            height: clamp(var(--print-figure-min-height), var(--print-figure-height), var(--print-figure-max-height));
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .print-figure.is-complex {
            width: clamp(var(--print-figure-min-width-complex), var(--print-figure-width), var(--print-figure-max-width-complex));
            height: clamp(var(--print-figure-min-height-complex), var(--print-figure-height), var(--print-figure-max-height-complex));
        }

        .print-figure svg {
            width: 100% !important;
            height: 100% !important;
            display: block;
        }

        .print-answer-block {
            margin-top: 6px;
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #94A3B8;
            border-radius: 3px;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <!-- é¡¶éƒ¨å¯¼èˆªç”± nav.js ç”Ÿæˆ -->

    <!-- é¡¶éƒ¨å¯¼èˆª (Special Design) -->
    <header class="header-special text-white py-5 px-8 shadow-2xl mb-8 no-print sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <div
                    class="w-14 h-14 bg-white/10 rounded-full flex items-center justify-center border-2 border-yellow-400/50 shadow-[0_0_15px_rgba(251,191,36,0.2)] backdrop-blur-md">
                    <i class="fas fa-shield-alt text-3xl text-yellow-400"></i>
                    <i
                        class="fas fa-check absolute -bottom-1 -right-1 text-green-400 bg-white rounded-full text-xs p-1 border border-white"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-bold logo-text flex items-center">
                        é”™é¢˜å…‹æ˜Ÿ <span
                            class="ml-3 px-2 py-0.5 bg-yellow-500/20 text-yellow-300 text-xs rounded border border-yellow-500/50 font-sans tracking-normal">V3.0
                            Pro</span>
                    </h1>
                    <p class="text-indigo-200 text-xs tracking-wider mt-1 opacity-80">INTELLIGENT MISTAKE BUSTER</p>
                </div>
            </div>
            <div class="flex space-x-4">
                <button onclick="printQuestionVer()"
                    class="bg-indigo-900/50 hover:bg-indigo-800/50 text-white px-4 py-2.5 rounded-lg font-medium transition backdrop-blur-md border border-white/10">
                    <i class="fas fa-file-alt mr-2"></i>æ‰“å°é¢˜ç›®
                </button>
                <button onclick="printAnswerVer()"
                    class="bg-indigo-900/50 hover:bg-indigo-800/50 text-white px-4 py-2.5 rounded-lg font-medium transition backdrop-blur-md border border-white/10">
                    <i class="fas fa-file-signature mr-2"></i>æ‰“å°ç­”æ¡ˆ
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow px-6 md:px-10 max-w-7xl mx-auto w-full pb-20 pt-10">

        <!-- ä¸Šä¼ åŒºåŸŸ -->
                <div id="uploadStage"
            class="text-center py-20 animate-fade-in no-print bg-white rounded-2xl shadow-sm border border-slate-200">
            <div class="max-w-xl mx-auto p-12 cursor-pointer border-2 border-dashed border-slate-300 rounded-2xl hover:border-blue-500 hover:bg-blue-50/30 transition-all duration-300 group"
                onclick="document.getElementById('fileInput').click()" id="dropZone">
                <input type="file" id="fileInput" class="hidden" accept="image/*"
                    onchange="handleFile(this.files[0]); this.value = null;">
                <div
                    class="text-6xl text-slate-200 group-hover:text-blue-400 group-hover:scale-110 transition-all duration-300 mb-6">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-700 mb-2">é”™é¢˜å…‹æ˜Ÿ - ç‚¹å‡»æˆ–ç²˜è´´é”™é¢˜å›¾ç‰‡</h3>
                <p class="text-slate-400 text-sm mb-8">æ”¯æŒè¯­æ•°è‹±ç‰©åŒ–ç”Ÿå…¨ç§‘è¯†åˆ«</p>
                <div class="flex justify-center space-x-4 text-xs text-gray-400">
                    <span class="px-3 py-1 bg-gray-100 rounded-full">ğŸ“· è‡ªåŠ¨è¯†åˆ«ç§‘ç›®</span>
                    <span class="px-3 py-1 bg-gray-100 rounded-full">ğŸ§  K12å…¨ç§‘é€»è¾‘</span>
                    <span class="px-3 py-1 bg-gray-100 rounded-full">âš¡ æ™ºèƒ½ç”Ÿæˆ30é“å˜å¼</span>
                </div>
            </div>
            <!-- æ¼”ç¤ºæ•°æ® -->
            <button onclick="loadDemo()"
                class="mt-8 text-indigo-500 hover:text-indigo-700 underline text-sm">è¯•ä¸€è¯•ï¼šæ¼”ç¤ºè¯­æ–‡ä½œæ–‡é¢˜</button>
        </div>

        <!-- åŠ è½½ä¸­ -->
                <div id="loadingStage" class="hidden text-center py-32 no-print">
            <div
                class="w-16 h-16 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mx-auto mb-6">
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">AI æ•™ç ”å‘˜æ­£åœ¨åˆ†æ...</h3>
            <p id="loadingText" class="text-gray-500 text-lg">è¯†åˆ«é¢˜ç›®å­¦ç§‘å½’å±...</p>
        </div>

        <!-- ç»“æœå±•ç¤º -->
        <div id="resultStage" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-8">

            <!-- å·¦ä¾§ï¼šé¢˜æºåˆ†æ -->
            <div class="lg:col-span-4 space-y-6 no-print">
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100 sticky top-4">
                    <div class="relative rounded-xl overflow-hidden mb-6 group cursor-pointer"
                        onclick="document.getElementById('fileInput').click()">
                        <img id="sourceImage" class="w-full object-contain" src="" alt="é”™é¢˜åŸå›¾">
                        <div
                            class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition text-white font-bold">
                            <i class="fas fa-cloud-upload-alt mr-2"></i>ä¸Šä¼ æ–°é¢˜ç›®                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="p-4 bg-indigo-50 rounded-xl">
                            <span class="text-xs text-indigo-600 font-bold uppercase tracking-wider">Subject
                                Analysis</span>
                            <h3 id="subjectTag" class="text-xl font-bold text-indigo-900 mt-1">--</h3>
                        </div>

                        <div>
                            <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-bold">æ ¸å¿ƒè€ƒç‚¹</span>
                            <p id="knowledgePoint" class="mt-3 text-gray-700 font-medium leading-relaxed">--</p>
                        </div>

                        <hr class="border-gray-100">

                        <div>
                            <span class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-xs font-bold">æ˜“é”™é™·é˜±</span>
                            <p id="trapAnalysis" class="mt-3 text-gray-600 text-sm leading-relaxed text-justify">--</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šå˜å¼é¢˜åº“ -->
            <div class="lg:col-span-8">

                                <!-- å˜å¼åˆ‡æ¢Tab -->
                <div class="flex space-x-2 bg-white p-2 rounded-full shadow-sm mb-6 no-print">
                    <button onclick="switchTab(0)" id="tab0"
                        class="flex-1 py-3 rounded-full text-center text-sm font-bold transition-all bg-indigo-600 text-white shadow-md">
                        åŒç±»å·©å›º (5é¢˜)
                    </button>
                    <button onclick="switchTab(1)" id="tab1"
                        class="flex-1 py-3 rounded-full text-center text-sm font-bold text-gray-500 hover:bg-gray-100 transition-all">
                        é€†å‘æ€ç»´ (5é¢˜)
                    </button>
                    <button onclick="switchTab(2)" id="tab2"
                        class="flex-1 py-3 rounded-full text-center text-sm font-bold text-gray-500 hover:bg-gray-100 transition-all">
                        ç»¼åˆæ‹“å±• (5é¢˜)
                    </button>
                </div>

                <!-- å˜å¼å†…å®¹åˆ—è¡¨ -->
                <div id="variationContent" class="space-y-6 no-print pb-20">
                    <!-- åŠ¨æ€æ’å…¥ -->
                </div>
            </div>
        </div>

        <!-- æ‰“å°åŒº(éšè—) -->
        <div id="printContainer" class="print-only max-w-4xl mx-auto">
            <div class="text-center border-b-2 border-black pb-6 mb-8">
                <h1 class="text-3xl font-bold text-black tracking-wider">é”™é¢˜å…‹æ˜Ÿ Â· ä¸“é¡¹å¼ºåŒ–è®­ç»ƒ</h1>
                <div class="flex justify-center space-x-12 mt-4 text-sm">
                    <span>å§“åï¼š__________</span>
                    <span>ç§‘ç›®ï¼š<span id="printSubject"></span></span>
                    <span>å¾—åˆ†ï¼š__________</span>
                </div>
            </div>
            <div id="printVariations" class="space-y-8">
                <!-- JSå¡«å…… -->
            </div>
        </div>

    </main>

    <script>
        // const API_KEY = 'YOUR_API_KEY'; // Removed for security
        // ä½¿ç”¨ Flash æ¨¡å‹æå‡å“åº”é€Ÿåº¦ï¼ˆä¿æŒé¢˜é‡ä¸å˜ï¼‰
        const MODEL_NAME = "gemini-3-flash-preview";
        const API_URL = '/api/chat'; // Updated to proxy
        const VARIATION_TYPES = ["åŒç±»å·©å›º", "é€†å‘æ€ç»´", "ç»¼åˆæ‹“å±•"];
        const VARIATION_TARGET_COUNT = 5;
        const INITIAL_BATCH_PLAN = [2, 2, 1];

        let currentVariations = [];
        let currentSubject = "";
        let activeTabIndex = 0;
        let generationToken = 0;
        let variationProgress = [];
        let currentContext = {
            subject: "",
            knowledge_point: "",
            trap_analysis: "",
            has_graphics: false,
            problem_summary: "",
            sub_questions: [],
            graphic_constraints: ""
        };

        const AI_REQUEST_OPTIONS = {
            temperature: 0.3
        };

        // UI Helpers
        const tabs = VARIATION_TYPES.map((type) => `${type} (${VARIATION_TARGET_COUNT}é¢˜)`);

        function resetVariationProgress() {
            variationProgress = VARIATION_TYPES.map(() => ({
                generated: 0,
                target: VARIATION_TARGET_COUNT,
                loading: false,
                error: ""
            }));
        }

        function getVariationTypeName(index) {
            return VARIATION_TYPES[index] || `é¢˜å‹${index + 1}`;
        }

        function updateTabLabels() {
            VARIATION_TYPES.forEach((typeName, index) => {
                const btn = document.getElementById(`tab${index}`);
                if (!btn) return;
                const progress = variationProgress[index];
                if (!progress) {
                    btn.innerText = `${typeName} (${VARIATION_TARGET_COUNT}é¢˜)`;
                    return;
                }

                const generated = Math.min(progress.generated, progress.target);
                const shouldShowProgress = progress.loading || generated > 0 || Boolean(progress.error);
                btn.innerText = shouldShowProgress
                    ? `${typeName} (${generated}/${progress.target})`
                    : `${typeName} (${progress.target}é¢˜)`;
            });
        }

        function renderLoadMoreButton(index, disabled = false) {
            return `
                <div class="pt-8 pb-4 text-center no-print">
                    <button onclick="loadMore(${index})" id="btn-load-more-${index}"
                        ${disabled ? "disabled" : ""}
                        class="btn-load-more text-white font-bold py-3 px-10 rounded-full shadow-lg flex items-center mx-auto space-x-2 ${disabled ? "opacity-60 cursor-not-allowed" : ""}">
                        <i class="fas fa-sync-alt ${disabled ? "fa-spin" : "animate-spin-slow"}"></i>
                        <span>${disabled ? "æœ¬ç±»é¢˜ç›®ç”Ÿæˆä¸­..." : "ç»§ç»­ç”Ÿæˆæœ¬ç±»é¢˜ç›® (10é¢˜)"}</span>
                    </button>
                    <p class="text-gray-400 text-xs mt-3">åŸºäºå½“å‰çŸ¥è¯†ç‚¹é€»è¾‘ Â· åˆ†æ‰¹å¼‚æ­¥ç”Ÿæˆ</p>
                </div>
            `;
        }

        resetVariationProgress();
        updateTabLabels();

        function switchTab(index) {
            activeTabIndex = index;
            updateTabLabels();

            // Update UI State
            document.querySelectorAll('button[id^="tab"]').forEach((btn, i) => {
                if (i === index) {
                    btn.className = "flex-1 py-3 rounded-full text-center text-sm font-bold transition-all bg-indigo-600 text-white shadow-md";
                } else {
                    btn.className = "flex-1 py-3 rounded-full text-center text-sm font-bold text-gray-500 hover:bg-gray-100 transition-all";
                }
            });

            const items = currentVariations[index]?.items || [];
            const progress = variationProgress[index] || { generated: 0, target: VARIATION_TARGET_COUNT, loading: false, error: "" };
            const typeName = getVariationTypeName(index);
            const container = document.getElementById('variationContent');

            if (items.length === 0) {
                if (progress.loading) {
                    container.innerHTML = `
                        <div class="bg-white rounded-2xl border border-indigo-100 p-10 text-center">
                            <div class="w-10 h-10 border-4 border-indigo-200 border-t-indigo-500 rounded-full animate-spin mx-auto mb-4"></div>
                            <div class="text-indigo-700 font-bold mb-2">${typeName}æ­£åœ¨ç”Ÿæˆä¸­...</div>
                            <div class="text-gray-500 text-sm">å·²å®Œæˆ ${progress.generated}/${progress.target} é¢˜ï¼Œç»“æœä¼šè‡ªåŠ¨å¡«å…¥é¡µé¢</div>
                        </div>
                    `;
                    return;
                }
                if (progress.error) {
                    container.innerHTML = `
                        <div class="bg-white rounded-2xl border border-red-200 p-10 text-center">
                            <div class="text-red-600 font-bold mb-2">${typeName}ç”Ÿæˆå¤±è´¥</div>
                            <div class="text-gray-500 text-sm">${progress.error}</div>
                        </div>
                    `;
                    return;
                }
                container.innerHTML = `<div class="text-center py-20 text-gray-400">æš‚æ— æ•°æ®</div>`;
                return;
            }

            const progressHint = progress.loading
                ? `<div class="mb-4 px-4 py-3 rounded-xl bg-indigo-50 text-indigo-700 text-sm font-medium border border-indigo-100">${typeName} æ­£åœ¨åˆ†æ‰¹ç”Ÿæˆï¼š${progress.generated}/${progress.target} é¢˜</div>`
                : "";

            container.innerHTML = items.map((item, i) => `
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 card-hover transition duration-300">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="q-badge">${i + 1}</div>
                            <span class="text-xs text-gray-500 font-bold bg-gray-100 px-2 py-1 rounded">
                                ${typeName} Â· ç¬¬${i + 1}é¢˜                            </span>
                        </div>
                        <button onclick="toggleAns('ans-${index}-${i}')" class="text-xs text-indigo-500 hover:bg-indigo-50 px-3 py-1 rounded-full transition">
                            æŸ¥çœ‹è§£æ <i class="fas fa-chevron-down ml-1"></i>
                        </button>
                    </div>
                    
                    <div class="math-content text-lg text-gray-800 leading-loose pl-11 mb-4">
                        ${sanitizeReadableText(item.question)}
                        ${item.svg ? `<div class="mt-4 p-4 bg-gray-50 border border-gray-100 rounded-lg flex justify-center">${sanitizeSvgMarkup(item.svg)}</div>` : ''}
                    </div>

                    <div id="ans-${index}-${i}" class="hidden pl-11 mt-4 pt-4 border-t border-dashed border-gray-200 bg-gray-50/50 rounded-b-xl -mx-6 px-6 pb-4">
                        <div class="text-green-700 font-bold mb-1"><i class="fas fa-check-circle mr-1"></i>å‚è€ƒç­”æ¡ˆ</div>
                        <div class="mb-4 math-content text-gray-800">${sanitizeReadableText(item.answer)}</div>
                        
                        <div class="text-orange-600 font-bold mb-1"><i class="fas fa-lightbulb mr-1"></i>æ·±åº¦è§£æ</div>
                        <div class="text-gray-600 text-sm math-content bg-orange-50 p-3 rounded-lg leading-relaxed text-justify">
                            ${sanitizeReadableText(item.solution)}
                        </div>
                    </div>
                </div>
            `).join('') + progressHint + renderLoadMoreButton(index, progress.loading);

            MathJax.typeset();
        }

        async function loadMore(index) {
            if (variationProgress[index]?.loading) return;

            const btn = document.getElementById(`btn-load-more-${index}`);
            if (btn) {
                btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ç”Ÿæˆä¸­...`;
                btn.disabled = true;
            }

            variationProgress[index].loading = true;
            variationProgress[index].error = "";
            updateTabLabels();
            if (activeTabIndex === index) switchTab(index);

            const typeName = getVariationTypeName(index);

            // åˆ†æ‰¹ç”Ÿæˆç­–ç•¥ï¼šå°†10é¢˜åˆ†æˆ4æ‰¹ï¼ˆ3+3+2+2ï¼‰ï¼Œé¿å…å•æ¬¡è¯·æ±‚è¶…æ—¶
            const batchSizes = [3, 3, 2, 2];
            const allItems = [];
            const existingQuestions = (currentVariations[index]?.items || [])
                .map((item) => sanitizeReadableText(item.question))
                .filter(Boolean)
                .slice(-30);

            try {
                for (const batchSize of batchSizes) {
                    if (btn) {
                        btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ç”Ÿæˆä¸­ (${allItems.length}/10)...`;
                    }

                    const batchItems = await generateVariationBatch({
                        typeName,
                        analysis: currentContext,
                        batchSize,
                        existingQuestions
                    });

                    if (batchItems.length > 0) {
                        appendVariationItems(index, batchItems);
                        allItems.push(...batchItems);
                        existingQuestions.push(...batchItems.map((item) => sanitizeReadableText(item.question)).filter(Boolean));
                        updateTabLabels();
                        if (activeTabIndex === index) switchTab(index);
                    }
                }

                renderPrintContent('question');

            } catch (error) {
                variationProgress[index].error = error.message || "ç”Ÿæˆå¤±è´¥";
                if (activeTabIndex === index) switchTab(index);
                alert(allItems.length > 0
                    ? `å·²ç”Ÿæˆ ${allItems.length} é¢˜ï¼Œéƒ¨åˆ†ç”Ÿæˆå¤±è´¥ï¼š${error.message}`
                    : `ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•ï¼š${error.message}`);
            } finally {
                variationProgress[index].loading = false;
                variationProgress[index].generated = Math.min((currentVariations[index]?.items || []).length, variationProgress[index].target);
                updateTabLabels();
                if (activeTabIndex === index) switchTab(index);
            }
        }

        window.toggleAns = (id) => {
            document.getElementById(id).classList.toggle('hidden');
        }

        function escapeBackslashesInStrings(text) {
            let out = "";
            let inStr = false;
            let escaped = false;
            for (let i = 0; i < text.length; i++) {
                const ch = text[i];
                if (!inStr) {
                    if (ch === '"') {
                        inStr = true;
                    }
                    out += ch;
                    continue;
                }

                if (ch === '"' && !escaped) {
                    inStr = false;
                    out += ch;
                    continue;
                }

                if (ch === '\\') {
                    out += '\\\\';
                    escaped = true;
                    continue;
                }

                if (ch === '\n' || ch === '\r') {
                    out += '\\n';
                    escaped = false;
                    continue;
                }

                out += ch;
                escaped = false;
            }
            return out;
        }

        function extractJsonText(raw) {
            if (!raw) return "";
            let text = String(raw).trim();
            text = text.replace(/^\uFEFF/, "");
            text = text.replace(/```json/gi, "").replace(/```/g, "");
            const first = text.indexOf("{");
            const last = text.lastIndexOf("}");
            if (first === -1 || last === -1 || last <= first) return "";
            text = text.slice(first, last + 1);
            text = text.replace(/[â€œâ€]/g, "\"").replace(/[â€˜â€™]/g, "'");
            text = text.replace(/,\s*([}\]])/g, "$1");
            text = escapeBackslashesInStrings(text);
            return text;
        }

        function tryParseJson(raw) {
            if (raw && typeof raw === "object") return raw;
            const jsonText = extractJsonText(raw);
            if (!jsonText) return null;
            try {
                return JSON.parse(jsonText);
            } catch (e) {
                return null;
            }
        }

        async function requestChat(payload) {
            const response = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errText = await response.text();
                console.error("API Error:", errText);
                if (response.status === 524) {
                    throw new Error("AIæ€è€ƒæ—¶é—´è¿‡é•¿(è¶…æ—¶)ï¼Œè¯·é‡è¯•");
                }
                throw new Error(`æœåŠ¡å™¨è¯·æ±‚å¤±è´¥(${response.status})`);
            }

            const result = await response.json();
            if (!result?.choices || result.choices.length === 0) {
                throw new Error(result?.error?.message || "APIæ— å“åº”");
            }

            if (result.parsed) return result.parsed;
            return result.choices[0]?.message?.content || "";
        }

        async function getJsonWithRepair(payload, schemaHint) {
            const raw = await requestChat(payload);
            if (raw && typeof raw === "object") return raw;
            let data = tryParseJson(raw);
            if (data) return data;

            const repairPrompt = `ä½ æ˜¯ä¸€åä¸¥æ ¼çš„JSONä¿®å¤å™¨ã€‚è¯·æŠŠä¸‹é¢å†…å®¹ä¿®å¤ä¸º**ä¸¥æ ¼JSON**ï¼Œä¸è¦è¾“å‡ºä»»ä½•è§£é‡Šæˆ–Markdownã€‚\n` +
                `è¦æ±‚ï¼šä¿æŒè¯­ä¹‰ä¸å˜ï¼Œå­—æ®µåå¿…é¡»ç¬¦åˆä»¥ä¸‹ç»“æ„æç¤ºï¼š${schemaHint}\n` +
                `æ³¨æ„ï¼šJSONå­—ç¬¦ä¸²ä¸­çš„åæ–œæ å¿…é¡»è½¬ä¹‰ï¼ˆä¾‹å¦‚ï¼šLaTeX ç”¨åŒåæ–œæ ï¼‰ã€‚\n` +
                `å¾…ä¿®å¤å†…å®¹ï¼š\n${raw}`;

            const repairedRaw = await requestChat({
                model: MODEL_NAME,
                messages: [{ role: "user", content: repairPrompt }],
                response_format: { type: "json_object" },
                ...AI_REQUEST_OPTIONS
            });

            if (repairedRaw && typeof repairedRaw === "object") return repairedRaw;
            data = tryParseJson(repairedRaw);
            if (data) return data;

            const minifyPrompt = `è¯·å°†ä¸‹é¢å†…å®¹è¾“å‡ºä¸º**ä¸€è¡Œä¸¥æ ¼JSON**ï¼ˆä¸è¦æ¢è¡Œã€ä¸è¦è§£é‡Šã€ä¸è¦Markdownï¼‰ã€‚` +
                `å­—æ®µç»“æ„æç¤ºï¼š${schemaHint}\n` +
                `æ³¨æ„ï¼šJSONå­—ç¬¦ä¸²ä¸­çš„åæ–œæ å¿…é¡»è½¬ä¹‰ã€‚\n` +
                `å†…å®¹ï¼š\n${raw}`;

            const minifiedRaw = await requestChat({
                model: MODEL_NAME,
                messages: [{ role: "user", content: minifyPrompt }],
                response_format: { type: "json_object" },
                ...AI_REQUEST_OPTIONS
            });

            if (minifiedRaw && typeof minifiedRaw === "object") return minifiedRaw;
            data = tryParseJson(minifiedRaw);
            if (data) return data;
            throw new Error("AIç”Ÿæˆçš„æ•°æ®æ ¼å¼æœ‰è¯¯ï¼Œè¯·é‡è¯•");
        }

        function getReadableTextScore(text) {
            if (!text) return -999;
            const chineseCount = (text.match(/[\u4e00-\u9fff]/g) || []).length;
            const badCount = (text.match(/[ï¿½]/g) || []).length;
            const latinMojibakeCount = (text.match(/[ÃƒÃ‚Ã¢â‚¬â„¢â€œâ€]/g) || []).length;
            return chineseCount * 2 - badCount * 8 - latinMojibakeCount * 3;
        }

        function tryRecoverUtf8Mojibake(text) {
            if (!text || !/[ÃƒÃ‚Ã¢â‚¬â„¢â€œâ€]/.test(text)) return text;
            try {
                const bytes = Uint8Array.from(Array.from(text).map((ch) => ch.charCodeAt(0) & 0xff));
                const recovered = new TextDecoder('utf-8', { fatal: false }).decode(bytes);
                return getReadableTextScore(recovered) > getReadableTextScore(text) ? recovered : text;
            } catch {
                return text;
            }
        }

        function sanitizeReadableText(value) {
            if (value === null || value === undefined) return "";
            let text = String(value)
                .replace(/\r\n/g, "\n")
                .replace(/\r/g, "\n")
                .replace(/^\uFEFF/, "")
                .replace(/\uFFFD/g, "")
                .replace(/[\u0000-\u0008\u000B\u000C\u000E-\u001F\u007F]/g, "");

            text = tryRecoverUtf8Mojibake(text);

            const replaceMap = {
                "ï¹£": "-",
                "ï¼": "-",
                "â€“": "-",
                "ï¼": "/",
                "ï¼…": "%",
                "âˆ¶": ":",
                "Â·": "Â·",
                "â€¢": "Â·",
                "ï½¥": "Â·",
                "ï¼ˆ": "ï¼ˆ",
                "ï¼‰": "ï¼‰",
                "ã€": "ã€",
                "ã€‘": "ã€‘",
                "â€œ": "â€œ",
                "â€": "â€",
                "â€˜": "â€˜",
                "â€™": "â€™",
                "â€¦": "â€¦",
                "â„ƒ": "â„ƒ",
                "Âµ": "Î¼"
            };

            for (const [from, to] of Object.entries(replaceMap)) {
                text = text.split(from).join(to);
            }

            text = text
                .replace(/[ \t]{2,}/g, " ")
                .replace(/\n{3,}/g, "\n\n")
                .trim();

            return text;
        }

        function sanitizeSvgMarkup(svgInput) {
            if (svgInput === null || svgInput === undefined) return "";
            let svg = String(svgInput)
                .replace(/^\uFEFF/, "")
                .replace(/\uFFFD/g, "")
                .replace(/[\u0000-\u0008\u000B\u000C\u000E-\u001F\u007F]/g, "")
                .replace(/```svg/gi, "")
                .replace(/```/g, "")
                .replace(/<script[\s\S]*?<\/script>/gi, "")
                .replace(/\son[a-z]+\s*=\s*"[^"]*"/gi, "")
                .replace(/\son[a-z]+\s*=\s*'[^']*'/gi, "")
                .replace(/\son[a-z]+\s*=\s*[^\s>]+/gi, "")
                .trim();

            if (!/<svg[\s>]/i.test(svg)) return "";
            return svg;
        }

        function normalizeAnalysis(data) {
            if (!data || typeof data !== "object") {
                throw new Error("AIåˆ†æç»“æœä¸ºç©º");
            }

            const subject = sanitizeReadableText(data.subject);
            const knowledge_point = sanitizeReadableText(data.knowledge_point);
            const trap_analysis = sanitizeReadableText(data.trap_analysis);

            if (!subject || !knowledge_point || !trap_analysis) {
                throw new Error("AIåˆ†æå­—æ®µç¼ºå¤±");
            }

            return {
                subject,
                knowledge_point,
                trap_analysis,
                has_graphics: Boolean(data.has_graphics),
                problem_summary: sanitizeReadableText(data.problem_summary || ""),
                graphic_constraints: sanitizeReadableText(data.graphic_constraints || ""),
                sub_questions: Array.isArray(data.sub_questions)
                    ? data.sub_questions.map((item) => sanitizeReadableText(item)).filter(Boolean)
                    : []
            };
        }

        function normalizeVariationItem(rawItem, hasGraphics) {
            const question = sanitizeReadableText(rawItem?.question);
            const answer = sanitizeReadableText(rawItem?.answer);
            const solution = sanitizeReadableText(rawItem?.solution);
            const svg = hasGraphics ? sanitizeSvgMarkup(rawItem?.svg) : "";

            return {
                question,
                answer,
                solution,
                ...(svg ? { svg } : {})
            };
        }

        function buildQuestionSimilarityKey(question) {
            return sanitizeReadableText(question || "")
                .toLowerCase()
                .replace(/[ï¼ˆ(]\d+[)ï¼‰]/g, "")
                .replace(/\d+(?:\.\d+)?/g, "#")
                .replace(/[ï¼Œã€‚ï¼›ï¼šã€â€œâ€â€˜â€™"'`~!@#$%^&*()_+\-=\[\]{}|\\<>/?Â·,.:;\s]/g, "");
        }

        function buildTextNGramSet(text, n = 3) {
            const safe = buildQuestionSimilarityKey(text);
            const grams = new Set();
            if (!safe) return grams;
            if (safe.length <= n) {
                grams.add(safe);
                return grams;
            }
            for (let i = 0; i <= safe.length - n; i++) {
                grams.add(safe.slice(i, i + n));
            }
            return grams;
        }

        function calcQuestionSimilarity(a, b) {
            const setA = buildTextNGramSet(a);
            const setB = buildTextNGramSet(b);
            if (setA.size === 0 || setB.size === 0) return 0;

            let intersection = 0;
            setA.forEach((gram) => {
                if (setB.has(gram)) intersection++;
            });
            const union = setA.size + setB.size - intersection;
            if (union <= 0) return 0;
            return intersection / union;
        }

        function isQuestionTooSimilar(question, candidates, threshold = 0.72) {
            const safeQuestion = sanitizeReadableText(question || "");
            if (!safeQuestion) return false;
            if (!Array.isArray(candidates) || candidates.length === 0) return false;
            return candidates.some((candidate) => calcQuestionSimilarity(safeQuestion, candidate) >= threshold);
        }

        function normalizeVariationItems(rawItems, hasGraphics, existingQuestions = []) {
            if (!Array.isArray(rawItems)) return [];
            const baseQuestions = existingQuestions.map((item) => sanitizeReadableText(item)).filter(Boolean);
            const seen = new Set(baseQuestions);
            const acceptedQuestions = [...baseQuestions];
            const output = [];

            for (const rawItem of rawItems) {
                const item = normalizeVariationItem(rawItem, hasGraphics);
                if (!item.question || !item.answer || !item.solution) continue;
                if (seen.has(item.question)) continue;
                if (isQuestionTooSimilar(item.question, acceptedQuestions)) continue;
                seen.add(item.question);
                acceptedQuestions.push(item.question);
                output.push(item);
            }

            return output;
        }

        function buildSubQuestionHint(subQuestions) {
            if (!Array.isArray(subQuestions) || subQuestions.length === 0) {
                return "åŸé¢˜ä¸ºå•é—®æˆ–æœªæ˜ç¡®å°é—®ã€‚";
            }
            return `åŸé¢˜åŒ…å«å°é—®ï¼š${subQuestions.join("ï¼›")}`;
        }

        function buildGraphicFactsHint(analysis) {
            if (!analysis?.has_graphics) {
                return "åŸé¢˜å›¾å½¢å…³é”®çº¦æŸï¼šæ— ï¼ˆæœ¬é¢˜ä¸ä¾èµ–é¢˜å›¾ï¼‰ã€‚";
            }
            const facts = sanitizeReadableText(analysis.graphic_constraints || "");
            if (!facts) {
                return "åŸé¢˜å›¾å½¢å…³é”®çº¦æŸï¼šæœªæä¾›é¢å¤–çº¦æŸï¼Œéœ€ä¸¥æ ¼ä¾æ®é¢˜å¹²æ–‡å­—ä¸æ•°å€¼ç”Ÿæˆã€‚";
            }
            return `åŸé¢˜å›¾å½¢å…³é”®çº¦æŸï¼ˆå¿…é¡»ä¿æŒå…³ç³»ä¸€è‡´ï¼Œå¯æ›¿æ¢æ•°å€¼ï¼‰ï¼š${facts}`;
        }

        function buildTextQualityConstraint() {
            return `
æ–‡æœ¬è´¨é‡è¦æ±‚ï¼š
1. æ‰€æœ‰æ–‡æœ¬å¿…é¡»æ˜¯å‰ç«¯å¯è¯»çš„ç®€ä½“ä¸­æ–‡ï¼Œä¸å¾—å‡ºç°ä¹±ç å­—ç¬¦ï¼ˆå¦‚ï¼šï¿½ã€é”›ã€éˆ¥ã€é™ ç­‰ï¼‰ã€‚
2. æ•°å­¦ã€ç‰©ç†ã€åŒ–å­¦ã€ç”Ÿç‰©ã€åœ°ç†ä¸­çš„ç¬¦å·å¿…é¡»è§„èŒƒæ˜¾ç¤ºï¼Œä¾‹å¦‚ï¼šÂ±ã€Ã—ã€Ã·ã€â‰¤ã€â‰¥ã€â‰ ã€âˆ ã€Â°ã€â„ƒã€Î¼ã€Î©ã€â†’ã€‚
3. åŒ–å­¦å¼ã€ç‰©ç†é‡ã€æ•°å­¦è¡¨è¾¾å¼è¯·ä½¿ç”¨å‰ç«¯å¯ç›´æ¥æ˜¾ç¤ºçš„è§„èŒƒå†™æ³•ï¼ˆå¯ä½¿ç”¨ LaTeXï¼‰ã€‚
4. ä¸è¦è¾“å‡ºå¥‡æ€ªæ§åˆ¶å­—ç¬¦ï¼Œä¸è¦è¾“å‡ºæ— æ„ä¹‰ç¬¦å·ä¸²ã€‚
`;
        }

        function buildOriginalityConstraint(batchSize) {
            return `
åŸåˆ›å·®å¼‚åŒ–çº¦æŸï¼ˆå¿…é¡»æ»¡è¶³ï¼‰ï¼š
1. ${batchSize}é¢˜åœ¨â€œæƒ…å¢ƒèƒŒæ™¯ã€è®¾é—®è§’åº¦ã€æ¡ä»¶ç»„åˆâ€ä¸Šå¿…é¡»æ˜æ˜¾ä¸åŒï¼Œè‡³å°‘è¦†ç›– 3 ç§ä¸åŒåˆ‡å…¥æ–¹å¼ã€‚
2. ç¦æ­¢ä»…æ›¿æ¢æ•°å­—/å•ä½/åç§°åå¤ç”¨åŒä¸€é¢˜å¹²æ¨¡æ¿ã€‚
3. åŒæ‰¹é¢˜ç›®é¢˜å¹²æ ¸å¿ƒè¯­å¥é‡å¤ç‡åº”ä½äº 30%ï¼Œè‹¥ç›¸ä¼¼å¿…é¡»ä¸»åŠ¨é‡å†™ã€‚
4. è‡³å°‘ä¸€åŠé¢˜ç›®ä½¿ç”¨ä¸åŒæ±‚è§£è·¯å¾„æˆ–ä¸åŒæ¡ä»¶ç»„åˆï¼Œä¸å¾—åŒå¥—è·¯å¹³ç§»ã€‚
5. è‹¥ä¸å·²ç”Ÿæˆé¢˜å¹²é«˜åº¦ç›¸ä¼¼ï¼Œå¿…é¡»æ”¹å†™åˆ°ä½ç›¸ä¼¼åå†è¾“å‡ºã€‚
`;
        }

        function buildGraphicStrongConstraint() {
            return `
å›¾å½¢ç”Ÿæˆè¶…ç»†ç²’åº¦å¼ºçº¦æŸï¼ˆéœ€è¦SVGæ—¶å¿…é¡»å…¨éƒ¨æ»¡è¶³ï¼‰ï¼š
1. å…ƒç´ ä¸€ä¸€å¯¹åº”ï¼šå…ˆåœ¨å†…éƒ¨å»ºç«‹é¢˜å¹²å…ƒç´ æ¸…å•ï¼ˆå¯¹è±¡ã€ç¬¦å·ã€æ•°å€¼ã€å•ä½ã€æ–¹å‘ã€æ¡ä»¶ï¼‰ï¼Œå†é€ä¸ªæ˜ å°„åˆ°å›¾ä¸­ï¼›ç¦æ­¢æ¼ç”»ã€é”™ç”»ã€é”™æ ‡ã€é”™ä½ã€æ”¹åã€‚
2. æ— å…³å…ƒç´ ç¦æ­¢ï¼šä¸å¾—æ·»åŠ é¢˜å¹²æœªå‡ºç°ä¸”å¯¹è§£é¢˜æ— è´¡çŒ®çš„å¯¹è±¡ã€è£…é¥°ã€æ ‡æ³¨æˆ–çº¿æ¡ã€‚
3. ç©ºé—´å…³ç³»ç¡¬çº¦æŸï¼šé¢˜å¹²ç»™å‡ºçš„ä¸Šä¸‹/å·¦å³/å†…å¤–/ä¸­é—´/é‚»æ¥/ç›¸äº¤/é‡åˆ/æ¥è§¦/åŒ…å«/å¹³è¡Œ/å‚ç›´å¿…é¡»é€æ¡æˆç«‹ã€‚
4. ç‚¹çº¿é¢ç²¾ç¡®å…³ç³»ï¼šå›ºå®šç‚¹ä¸å¯æ¼‚ç§»ï¼›ç«¯ç‚¹å¿…é¡»è½åœ¨æŒ‡å®šçº¿/é¢ä¸Šï¼›è¿æ¥å¿…é¡»æ¥åˆ°æŒ‡å®šèŠ‚ç‚¹ï¼›ç‚¹åœ¨çº¿ä¸Šã€é¢å†…ã€è¾¹ç•Œä¸Šçš„å…³ç³»å¿…é¡»ä¸¥æ ¼æ­£ç¡®ã€‚
5. å‡ ä½•ä¸æ‹“æ‰‘ä¸€è‡´ï¼šå…±çº¿ã€å…±åœ†ã€è§’åº¦ã€é•¿åº¦æ¯”ä¾‹ã€å¯¹ç§°ã€è¿é€šã€é—­åˆå…³ç³»å¿…é¡»ä¸é¢˜æ„ä¸€è‡´ï¼Œç¦æ­¢è‡ªç›¸çŸ›ç›¾ã€‚
6. æ•°å€¼æ ‡æ³¨ä¸€è‡´ï¼šå›¾ä¸­æ–‡å­—ã€å­—æ¯ç¼–å·ã€ä¸Šä¸‹æ ‡ã€å•ä½ã€ç®­å¤´æ–¹å‘å¿…é¡»ä¸é¢˜å¹²å®Œå…¨ä¸€è‡´ï¼ŒåŒä¸€å¯¹è±¡å‘½åå¿…é¡»å‰åä¸€è‡´ã€‚
7. ç‰©ç†ä¸–ç•Œä¸€è‡´æ€§ï¼ˆæ ¸å¿ƒï¼‰ï¼š
   - åŠ›å­¦æ¥è§¦çº¦æŸï¼šæ¥è§¦=è¾¹ç•Œæ¥è§¦ä¸”æ— ç©¿é€ï¼›åˆ†ç¦»=å­˜åœ¨å¯è§é—´éš™ï¼›ç¦æ­¢â€œç‰©ä½“åµŒå…¥æ–œé¢/å¢™ä½“/åœ°é¢/è½¨é“å†…éƒ¨â€ã€‚
   - åŠ›å­¦ä½ç½®çº¦æŸï¼šæ»‘å—/å°è½¦å¿…é¡»ä½äºè½¨é“æˆ–å¡é¢è¡¨é¢ï¼›æ‚¬æŒ‚ç‰©å¿…é¡»åœ¨ç»³ç«¯ä¸‹æ–¹ï¼›é“°æ¥ç‚¹å¿…é¡»è½åœ¨æ†ä»¶ç«¯ç‚¹æˆ–æŒ‡å®šèŠ‚ç‚¹ã€‚
   - åŠ›å­¦æ–¹å‘çº¦æŸï¼šé‡åŠ›å§‹ç»ˆç«–ç›´å‘ä¸‹ï¼›æ”¯æŒåŠ›å‚ç›´äºæ¥è§¦é¢ï¼›æ‘©æ“¦åŠ›æ²¿æ¥è§¦é¢åˆ‡å‘ï¼›å¼¹åŠ›æ²¿å¼¹ç°§è½´çº¿ã€‚
   - åŠ›å­¦è¿ç»“çº¦æŸï¼šç»†ç»³åªèƒ½æ‹‰ä¸èƒ½æ¨ï¼Œå—åŠ›æ²¿ç»³æ–¹å‘ï¼›æ»‘è½®ç»³æ®µè¿ç»­ï¼Œç»³é•¿çº¦æŸä¸è¿åŠ¨æ–¹å‘è‡ªæ´½ã€‚
   - åŠ›å­¦å—åŠ›æ ‡æ³¨ï¼šå—åŠ›ç®­å¤´èµ·ç‚¹å¿…é¡»åœ¨å—åŠ›ç‰©ä½“æˆ–æ¥è§¦ç‚¹ï¼Œä¸å¾—æ‚¬ç©ºï¼›åŒä¸€åŠ›ä¸å¯é‡å¤æˆ–é—æ¼å…³é”®ä½œç”¨çº¿ã€‚
   - ç”µå­¦ï¼šç”µè·¯è¿æ¥å¿…é¡»çœŸå®è¿é€šï¼Œç«¯ç‚¹å¯¹åº”æ­£ç¡®ï¼›ä¸²å¹¶è”å…³ç³»ã€ææ€§ã€å¼€å…³çŠ¶æ€ä¸é¢˜æ„ä¸€è‡´ï¼Œç¦æ­¢æ‚¬ç©ºæ–­çº¿ã€‚
   - å…‰å­¦ï¼šå…‰çº¿ä¼ æ’­ã€æ³•çº¿ä½ç½®ã€åå°„/æŠ˜å°„æ–¹å‘ä¸æˆåƒä½ç½®å¿…é¡»ç¬¦åˆç‰©ç†è§„å¾‹ã€‚
   - åŒ–å­¦ï¼šç»“æ„å¼/é”®å‹/å®˜èƒ½å›¢/é…ä½ä¸é¢˜å¹²æˆ– SMILES ä¸€è‡´ï¼Œå®éªŒè£…ç½®è¿æ¥é¡ºåºä¸æµå‘åˆç†ã€‚
   - ç”Ÿç‰©ï¼šç»“æ„å±‚çº§ä¸ç›¸å¯¹ä½ç½®ç¬¦åˆæ•™æè§„èŒƒï¼ˆè†œå†…å¤–ã€ç»†èƒå™¨ä½ç½®ã€æµç¨‹æ–¹å‘ï¼‰ã€‚
   - åœ°ç†ï¼šæ–¹å‘ã€å›¾ä¾‹ã€åŒºåŸŸå¯¹åº”ã€é£å‘/æ°´æµ/ç­‰å€¼çº¿å…³ç³»ä¸åœ°ç†äº‹å®ä¸€è‡´ã€‚
8. æ¯”ä¾‹ä¸è¾¹ç•Œçº¦æŸï¼šå¯¹è±¡å°ºå¯¸ã€é—´è·ã€è§’åº¦æ¯”ä¾‹åº”ä¸é¢˜æ„ä¸€è‡´ï¼›ç¦æ­¢æ ‡ç­¾äº’ç›¸é®æŒ¡å…³é”®å…ƒç´ ï¼›å…³é”®å¯¹è±¡ä¸å¾—è¶…å‡ºç”»å¸ƒæˆ–è¢«è£åˆ‡ã€‚
9. å…ˆè‡ªæ£€å†è¾“å‡ºï¼šé€é¡¹æ ¸å¯¹å…ƒç´ ã€ä½ç½®ã€è¿æ¥ã€æ–¹å‘ã€æ ‡ç­¾ã€å•ä½ã€ç‰©ç†è§„å¾‹ï¼›ä»»ä½•ä¸€é¡¹ä¸æ»¡è¶³å…ˆé‡ç»˜ï¼Œä¸¥ç¦å¸¦é”™è¾“å‡ºã€‚
`;
        }

        function buildPhysicsAuditPrompt({ analysis, typeName, items }) {
            const subject = sanitizeReadableText(analysis?.subject || "");
            const knowledge = sanitizeReadableText(analysis?.knowledge_point || "");
            const trap = sanitizeReadableText(analysis?.trap_analysis || "");
            const summary = sanitizeReadableText(analysis?.problem_summary || "");
            const graphicFacts = buildGraphicFactsHint(analysis);
            const compactItems = (Array.isArray(items) ? items : []).map((item, index) => ({
                index,
                question: sanitizeReadableText(item?.question || ""),
                svg: sanitizeSvgMarkup(item?.svg || "")
            }));

            return `
ä½ æ˜¯â€œå…¨å­¦ç§‘é¢˜å›¾ç‰©ç†ä¸€è‡´æ€§å®¡è®¡å™¨ + SVGä¿®å¤å™¨â€ã€‚
ä»»åŠ¡ï¼šå¯¹æ¯ä¸ªé¢˜å›¾è¿›è¡ŒçœŸå®ä¸–ç•Œä¸€è‡´æ€§å®¡è®¡ï¼›è‹¥å‘ç°ä»»ä½•è¿è§„ï¼Œå¿…é¡»ä¿®å¤ä¸ºæ­£ç¡® SVGã€‚

èƒŒæ™¯ï¼š
- å­¦ç§‘ï¼š${subject}
- ç±»å‹ï¼š${sanitizeReadableText(typeName || "")}
- æ ¸å¿ƒè€ƒç‚¹ï¼š${knowledge}
- æ˜“é”™é™·é˜±ï¼š${trap}
- é¢˜å¹²æ‘˜è¦ï¼š${summary || "ï¼ˆæ— ï¼‰"}
- ${graphicFacts}

å¿…é¡»æ‰§è¡Œçš„å¼ºçº¦æŸï¼š
${buildGraphicStrongConstraint()}

å…³é”®å®¡è®¡ç‚¹ï¼ˆå¿…é¡»é€é¢˜æ£€æŸ¥ï¼‰ï¼š
1. æ¥è§¦å…³ç³»ï¼šæ¥è§¦å¯¹è±¡åªèƒ½è¾¹ç•Œæ¥è§¦ï¼Œä¸¥ç¦å‡ ä½•ç©¿é€ï¼ˆå¦‚æ»‘å—è¿›å…¥å¡é¢å†…éƒ¨ï¼‰ã€‚
2. ä½ç½®å…³ç³»ï¼šä¸Šä¸‹/å·¦å³/å†…å¤–/ä¸­é—´/é‚»æ¥/ç›¸äº¤/åŒ…å«/å¹³è¡Œ/å‚ç›´ä¸é¢˜å¹²å®Œå…¨ä¸€è‡´ã€‚
3. çº¦æŸå…³ç³»ï¼šæ»‘å—åœ¨è½¨é“é¢ä¸Šã€ç»³å­è¿ç»­ã€æ”¯ç‚¹å›ºå®šã€é“°é“¾åœ¨èŠ‚ç‚¹ã€å›è·¯çœŸå®è¿é€šã€‚
4. æ–¹å‘å…³ç³»ï¼šé‡åŠ›å‘ä¸‹ã€æ³•çº¿å‚é¢ã€æ‘©æ“¦åˆ‡å‘ã€ç®­å¤´æ–¹å‘ä¸ç‰©ç†æ„ä¹‰ä¸€è‡´ã€‚
5. æ ‡æ³¨å…³ç³»ï¼šæ ‡ç­¾ã€å•ä½ã€ä¸‹æ ‡ã€ç¼–å·ä¸é¢˜å¹²ä¸€è‡´ï¼Œä¸é®æŒ¡å…³é”®ç»“æ„ã€‚

è¾“å…¥é¢˜ç›®æ•°ç»„ï¼ˆJSONï¼‰ï¼š
${JSON.stringify(compactItems)}

è¾“å‡ºæ ¼å¼ï¼ˆä¸¥æ ¼JSONï¼Œä¸è¦è§£é‡Šï¼Œä¸è¦Markdownï¼‰ï¼š
{
  "items": [
    {
      "index": 0,
      "is_valid": true,
      "violations": [],
      "corrected_svg": "<svg ...>...</svg>"
    }
  ]
}

è¾“å‡ºè¦æ±‚ï¼š
1. æ¯ä¸ª index éƒ½å¿…é¡»è¿”å›ã€‚
2. è‹¥ is_valid=falseï¼Œå¿…é¡»åœ¨ violations åˆ—å‡ºè¿è§„ç‚¹ï¼Œå¹¶ç»™å‡ºä¿®å¤åçš„ corrected_svgã€‚
3. è‹¥ is_valid=trueï¼Œä¹Ÿå¿…é¡»è¿”å› corrected_svgï¼ˆå¯ä¸åŸå›¾ä¸€è‡´ï¼‰ã€‚
4. corrected_svg å¿…é¡»æ˜¯å®Œæ•´ã€å¯æ¸²æŸ“ã€å•ä¸ª <svg> æ ¹èŠ‚ç‚¹ã€‚
`;
        }

        async function enforcePhysicsConstraintsForItems({ analysis, typeName, items }) {
            if (!analysis?.has_graphics) return Array.isArray(items) ? items : [];
            if (!Array.isArray(items) || items.length === 0) return [];

            const hasSvg = items.some((item) => sanitizeSvgMarkup(item?.svg || ""));
            if (!hasSvg) return items;

            try {
                const auditPrompt = buildPhysicsAuditPrompt({ analysis, typeName, items });
                const auditData = await getJsonWithRepair({
                    model: MODEL_NAME,
                    messages: [{ role: "user", content: auditPrompt }],
                    response_format: { type: "json_object" },
                    ...AI_REQUEST_OPTIONS
                }, "items[{index,is_valid,violations[],corrected_svg}]");

                const rows = Array.isArray(auditData?.items) ? auditData.items : [];
                if (rows.length === 0) return items;

                const rowMap = new Map();
                rows.forEach((row) => {
                    const index = Number(row?.index);
                    if (!Number.isFinite(index) || index < 0) return;
                    rowMap.set(index, row);
                });

                return items.map((item, index) => {
                    const row = rowMap.get(index);
                    if (!row) return item;
                    const fixedSvg = sanitizeSvgMarkup(row?.corrected_svg || "");
                    if (!fixedSvg) return item;
                    return { ...item, svg: fixedSvg };
                });
            } catch (error) {
                console.warn("ç‰©ç†ä¸€è‡´æ€§å®¡è®¡å¤±è´¥ï¼Œä¿ç•™åŸå§‹å›¾å½¢ï¼š", error);
                return items;
            }
        }

        function buildVariationPrompt({ typeName, analysis, batchSize, existingQuestions = [], fillOnly = false }) {
            const subQ = buildSubQuestionHint(analysis.sub_questions);
            const graphicFacts = buildGraphicFactsHint(analysis);
            const dedupeHint = existingQuestions.length > 0
                ? `ä»¥ä¸‹é¢˜å¹²ç¦æ­¢é‡å¤ï¼š\n${existingQuestions.slice(-8).map((item, idx) => `${idx + 1}. ${sanitizeReadableText(item)}`).join("\n")}`
                : "";
            const fillHint = fillOnly ? `è¡¥é½ ${batchSize} é¢˜ï¼Œä¸”ä¸å¾—ä¸å·²ç”Ÿæˆé¢˜ç›®é‡å¤ã€‚` : `ç”Ÿæˆ ${batchSize} é¢˜ï¼Œä¸”å½¼æ­¤ä¸å¾—é‡å¤ã€‚`;

            return `
è¯·æ ¹æ®ä»¥ä¸‹åˆ†æç”Ÿæˆå˜å¼é¢˜ï¼ˆä»…ç”Ÿæˆè¯¥ç±»å‹ï¼Œä¸è¦é‡å¤åˆ†æï¼‰ï¼š
å­¦ç§‘ï¼š${analysis.subject}
æ ¸å¿ƒè€ƒç‚¹ï¼š${analysis.knowledge_point}
æ˜“é”™é™·é˜±ï¼š${analysis.trap_analysis}
é¢˜å¹²æ‘˜è¦ï¼š${analysis.problem_summary || "ï¼ˆæ— ï¼‰"}
${subQ}
${graphicFacts}
å›¾å½¢è¦æ±‚ï¼š${analysis.has_graphics ? "éœ€è¦SVG" : "ä¸éœ€è¦SVG"}
ç±»å‹ï¼š${typeName}

${buildTextQualityConstraint()}
${buildOriginalityConstraint(batchSize)}
${analysis.has_graphics ? buildGraphicStrongConstraint() : ""}
${dedupeHint}

ä»»åŠ¡ï¼š${fillHint} æ¯é“é¢˜å…è®¸â€œé¢˜å¹² + å¤šå°é—®â€ï¼Œç”¨ï¼ˆ1ï¼‰ï¼ˆ2ï¼‰ï¼ˆ3ï¼‰æ ‡æ³¨å°é—®ï¼Œéš¾åº¦ä¸åŸé¢˜ä¸€è‡´ã€‚
${analysis.has_graphics ? "æ¯é“é¢˜å¿…é¡»åŒ…å« svg å­—æ®µï¼Œå€¼ä¸ºå¯ç›´æ¥æ¸²æŸ“çš„ SVG ä»£ç ï¼ˆä¸è¦ Markdownï¼‰ã€‚" : ""}

æ³¨æ„ï¼šJSONå­—ç¬¦ä¸²ä¸­çš„åæ–œæ å¿…é¡»è½¬ä¹‰ï¼ˆä¾‹å¦‚ï¼šLaTeX ç”¨åŒåæ–œæ ï¼‰ã€‚
ä»…è¾“å‡ºä¸¥æ ¼JSONï¼Œä¸è¦è¾“å‡ºä»»ä½•è§£é‡Šæˆ–Markdownã€‚è¾“å‡ºæ ¼å¼ï¼š
{
  "items": [
    { "question": "...", "answer": "...", "solution": "...", "svg": "..." },
    ... (${batchSize}é¢˜)
  ]
}
`;
        }

        async function generateVariationBatch({ typeName, analysis, batchSize, existingQuestions = [] }) {
            const prompt = buildVariationPrompt({
                typeName,
                analysis,
                batchSize,
                existingQuestions,
                fillOnly: false
            });

            const data = await getJsonWithRepair({
                model: MODEL_NAME,
                messages: [{ role: "user", content: prompt }],
                response_format: { type: "json_object" },
                ...AI_REQUEST_OPTIONS
            }, "items[{question,answer,solution,svg?}]");

            let items = normalizeVariationItems(data?.items, analysis.has_graphics, existingQuestions);

            if (items.length < batchSize) {
                const missing = batchSize - items.length;
                const fillPrompt = buildVariationPrompt({
                    typeName,
                    analysis,
                    batchSize: missing,
                    existingQuestions: existingQuestions.concat(items.map((item) => item.question)),
                    fillOnly: true
                });

                const fillData = await getJsonWithRepair({
                    model: MODEL_NAME,
                    messages: [{ role: "user", content: fillPrompt }],
                    response_format: { type: "json_object" },
                    ...AI_REQUEST_OPTIONS
                }, "items[{question,answer,solution,svg?}]");

                const fillItems = normalizeVariationItems(
                    fillData?.items,
                    analysis.has_graphics,
                    existingQuestions.concat(items.map((item) => item.question))
                );
                items = items.concat(fillItems);
            }

            items = items.slice(0, batchSize);
            items = await enforcePhysicsConstraintsForItems({
                analysis,
                typeName,
                items
            });

            return items;
        }

        function appendVariationItems(index, incomingItems) {
            if (!currentVariations[index]) return;
            if (!Array.isArray(incomingItems) || incomingItems.length === 0) return;

            const currentItems = Array.isArray(currentVariations[index].items) ? currentVariations[index].items : [];
            const merged = normalizeVariationItems(
                incomingItems,
                Boolean(currentContext.has_graphics),
                currentItems.map((item) => item.question)
            );

            if (merged.length > 0) {
                currentVariations[index].items = currentItems.concat(merged);
            }

            if (variationProgress[index]) {
                variationProgress[index].generated = Math.min(currentVariations[index].items.length, variationProgress[index].target);
            }
        }

        function ensureGenerationTaskActive(taskToken) {
            if (taskToken !== generationToken) {
                throw new Error("ä»»åŠ¡å·²å–æ¶ˆ");
            }
        }

        async function generateInitialVariations(analysis, taskToken) {
            const tasks = VARIATION_TYPES.map((typeName, index) => (async () => {
                const localQuestions = [];
                variationProgress[index].loading = true;
                variationProgress[index].error = "";
                updateTabLabels();
                if (activeTabIndex === index) switchTab(index);

                try {
                    for (const batchSize of INITIAL_BATCH_PLAN) {
                        ensureGenerationTaskActive(taskToken);
                        const batchItems = await generateVariationBatch({
                            typeName,
                            analysis,
                            batchSize,
                            existingQuestions: localQuestions
                        });
                        ensureGenerationTaskActive(taskToken);

                        if (batchItems.length > 0) {
                            appendVariationItems(index, batchItems);
                            localQuestions.push(...batchItems.map((item) => item.question));
                            updateTabLabels();
                            if (activeTabIndex === index) switchTab(index);
                            renderPrintContent('question');
                        }
                    }

                    const generatedCount = currentVariations[index]?.items?.length || 0;
                    if (generatedCount < VARIATION_TARGET_COUNT) {
                        variationProgress[index].error = `æœ¬ç±»é¢˜ç›®ç”Ÿæˆä¸è¶³ï¼š${generatedCount}/${VARIATION_TARGET_COUNT}`;
                    }
                } catch (error) {
                    if (error.message !== "ä»»åŠ¡å·²å–æ¶ˆ") {
                        variationProgress[index].error = error.message || "ç”Ÿæˆå¤±è´¥";
                    }
                } finally {
                    variationProgress[index].loading = false;
                    const generated = currentVariations[index]?.items?.length || 0;
                    variationProgress[index].generated = Math.min(generated, variationProgress[index].target);
                    updateTabLabels();
                    if (activeTabIndex === index) switchTab(index);
                }
            })());

            await Promise.allSettled(tasks);
        }

        // Analysis Logic
        async function startAnalysis(imageData) {
            // Credit Check
            let creditOk = true;
            try {
                if (typeof window.CyberGongtou?.useCredit === "function") {
                    creditOk = window.CyberGongtou.useCredit();
                }
            } catch (e) {
                console.warn("Credit check failed, proceed without blocking.", e);
                creditOk = true;
            }
            if (!creditOk) return;

            generationToken++;
            const taskToken = generationToken;
            resetVariationProgress();
            activeTabIndex = 0;

            document.getElementById('uploadStage').classList.add('hidden');
            document.getElementById('loadingStage').classList.remove('hidden');
            document.getElementById('resultStage').classList.add('hidden');

            const loadingTexts = [
                "æ­£åœ¨è¯†åˆ«å­¦ç§‘ç±»å‹...",
                "æ­£åœ¨æå–é¢˜å¹²ä¸å…³é”®æ¡ä»¶...",
                "æ­£åœ¨åˆ†ææ ¸å¿ƒè€ƒç‚¹ä¸æ˜“é”™é™·é˜±...",
                "åˆ†æå®Œæˆåå°†åˆ†æ‰¹å±•ç¤ºé¢˜ç›®..."
            ];
            let step = 0;
            const interval = setInterval(() => {
                document.getElementById('loadingText').innerText = loadingTexts[step % loadingTexts.length];
                step++;
            }, 1200);

            try {
                let analysis;
                if (imageData === "DEMO_MODE") {
                    await new Promise(r => setTimeout(r, 1200));
                    const demo = getDemoData();
                    analysis = {
                        subject: sanitizeReadableText(demo.subject),
                        knowledge_point: sanitizeReadableText(demo.knowledge_point),
                        trap_analysis: sanitizeReadableText(demo.trap_analysis),
                        has_graphics: false,
                        problem_summary: "æ¼”ç¤ºé¢˜ç›®ï¼šä½œæ–‡ä¿®è¾ä¸“é¡¹ç»ƒä¹ ã€‚",
                        graphic_constraints: "",
                        sub_questions: []
                    };
                    document.getElementById('sourceImage').src = "https://images.unsplash.com/photo-1456513080510-7bf3a84b82f8?q=80&w=1000";
                } else {
                    document.getElementById('sourceImage').src = imageData;
                    const base64Content = imageData.split(',')[1];

                    const analysisPrompt = `
ä½ æ˜¯ä¸€ä½K12å…¨ç§‘é‡‘ç‰Œæ•™ç ”å‘˜ã€‚è¯·åªåšé¢˜ç›®åˆ†æï¼Œä¸è¦ç”Ÿæˆå˜å¼é¢˜ã€‚
è¾“å‡ºå¿…é¡»æ˜¯å‰ç«¯å¯è¯»ä¸­æ–‡ï¼Œä¸å¾—å‡ºç°ä¹±ç å­—ç¬¦ï¼ˆå¦‚ï¼šï¿½ã€é”›ã€éˆ¥ã€é™ï¼‰ã€‚
æ¶‰åŠæ•°å­¦ã€ç‰©ç†ã€åŒ–å­¦ã€ç”Ÿç‰©ã€åœ°ç†æ—¶ï¼Œç¬¦å·è¯·è§„èŒƒæ˜¾ç¤ºï¼Œä¾‹å¦‚ï¼šÂ±ã€Ã—ã€Ã·ã€â‰¤ã€â‰¥ã€â‰ ã€âˆ ã€Â°ã€â„ƒã€Î¼ã€Î©ã€â†’ã€‚
å¦‚æœé¢˜ç›®åŒ…å«å¤šä¸ªå°é—®ï¼Œè¯·æ‹†åˆ†ä¸º sub_questions æ•°ç»„ã€‚
problem_summary ç”¨ä¸€å¥è¯æ¦‚æ‹¬é¢˜å¹²ä¸å·²çŸ¥æ¡ä»¶ã€‚
åˆ¤æ–­æ˜¯å¦éœ€è¦å›¾å½¢ï¼šåªæœ‰è§£é¢˜å¿…é¡»ä¾èµ–é¢˜å›¾/ç¤ºæ„å›¾æ—¶ï¼Œhas_graphics æ‰ä¸º trueã€‚
è‹¥ has_graphics ä¸º trueï¼Œè¯·é¢å¤–è¾“å‡º graphic_constraintsï¼š
- ç”¨ç´§å‡‘ä¸­æ–‡åˆ—å‡ºå›¾ä¸­â€œå¯¹è±¡æ¸…å• + ç©ºé—´å…³ç³» + è¿æ¥å…³ç³» + æ–¹å‘å…³ç³» + ç‰©ç†/åŒ–å­¦/ç”Ÿç‰©/åœ°ç†å…³é”®çœŸå®æ€§çº¦æŸâ€ï¼›
- å¿…é¡»åŒ…å«ä¸Šä¸‹/å·¦å³/å†…å¤–/é‚»æ¥/ç›¸äº¤/åŒ…å«/å¹³è¡Œ/å‚ç›´ç­‰å¯åˆ¤å®šå…³ç³»ï¼ˆæŒ‰é¢˜ç›®å®é™…å‡ºç°é¡¹ç»™å‡ºï¼‰ï¼›
- è‹¥æ— å›¾å½¢æˆ–æ— æ³•åˆ¤å®šï¼Œgraphic_constraints è¾“å‡ºç©ºå­—ç¬¦ä¸²ã€‚
æ³¨æ„ï¼šJSONå­—ç¬¦ä¸²ä¸­çš„åæ–œæ å¿…é¡»è½¬ä¹‰ï¼ˆä¾‹å¦‚ï¼šLaTeX ç”¨åŒåæ–œæ ï¼‰ã€‚
ä»…è¾“å‡ºä¸¥æ ¼JSONï¼Œä¸è¦è¾“å‡ºä»»ä½•è§£é‡Šæˆ–Markdownã€‚è¾“å‡ºæ ¼å¼ï¼š
{
  "subject": "...",
  "knowledge_point": "...",
  "trap_analysis": "...",
  "has_graphics": true/false,
  "problem_summary": "...",
  "graphic_constraints": "...",
  "sub_questions": ["(1)...", "(2)..."]
}
`;

                    const analysisRaw = await getJsonWithRepair({
                        model: MODEL_NAME,
                        messages: [{
                            role: "user",
                            content: [
                                { type: "text", text: analysisPrompt },
                                { type: "image_url", image_url: { url: `data:image/jpeg;base64,${base64Content}` } }
                            ]
                        }],
                        response_format: { type: "json_object" },
                        ...AI_REQUEST_OPTIONS
                    }, "analysis:{subject,knowledge_point,trap_analysis,has_graphics,problem_summary,graphic_constraints,sub_questions[]}");

                    analysis = normalizeAnalysis(analysisRaw);
                }

                ensureGenerationTaskActive(taskToken);
                clearInterval(interval);

                // å…ˆå±•ç¤ºåˆ†æç»“æœ
                currentSubject = analysis.subject;
                currentContext = {
                    subject: analysis.subject,
                    knowledge_point: analysis.knowledge_point,
                    trap_analysis: analysis.trap_analysis,
                    has_graphics: Boolean(analysis.has_graphics),
                    problem_summary: sanitizeReadableText(analysis.problem_summary || ""),
                    graphic_constraints: sanitizeReadableText(analysis.graphic_constraints || ""),
                    sub_questions: Array.isArray(analysis.sub_questions) ? analysis.sub_questions.map((q) => sanitizeReadableText(q)).filter(Boolean) : []
                };

                currentVariations = VARIATION_TYPES.map((type) => ({ type, items: [] }));
                variationProgress.forEach((item) => {
                    item.generated = 0;
                    item.loading = true;
                    item.error = "";
                });

                document.getElementById('subjectTag').innerText = currentSubject;
                document.getElementById('printSubject').innerText = currentSubject;
                document.getElementById('knowledgePoint').innerText = currentContext.knowledge_point;
                document.getElementById('trapAnalysis').innerText = currentContext.trap_analysis;

                document.getElementById('loadingStage').classList.add('hidden');
                document.getElementById('resultStage').classList.remove('hidden');
                updateTabLabels();
                switchTab(0);
                renderPrintContent('question');

                // åˆ†ç±»å‹å¹¶è¡Œã€åˆ†æ‰¹å¡«å……é¢˜ç›®
                await generateInitialVariations(currentContext, taskToken);

            } catch (error) {
                clearInterval(interval);
                if (error.message !== "ä»»åŠ¡å·²å–æ¶ˆ") {
                    console.error(error);
                    alert("å‡ºé”™å•¦ï¼š" + error.message);
                    document.getElementById('loadingStage').classList.add('hidden');
                    document.getElementById('uploadStage').classList.remove('hidden');
                }
            }
        }

        function extractSvgSize(svg) {
            if (!svg || typeof svg !== "string") return null;
            const widthMatch = svg.match(/\bwidth\s*=\s*["']?([\d.]+)([a-z%]*)["']?/i);
            const heightMatch = svg.match(/\bheight\s*=\s*["']?([\d.]+)([a-z%]*)["']?/i);
            if (!widthMatch || !heightMatch) return null;
            const widthUnit = widthMatch[2] || "px";
            const heightUnit = heightMatch[2] || "px";
            return {
                width: `${widthMatch[1]}${widthUnit}`,
                height: `${heightMatch[1]}${heightUnit}`
            };
        }

        function syncPrintFigureSize() {
            let svg = null;
            for (const vType of currentVariations) {
                if (vType?.items?.length) {
                    const found = vType.items.find((it) => typeof it.svg === "string" && it.svg.trim());
                    if (found) {
                        svg = found.svg;
                        break;
                    }
                }
            }
            const size = extractSvgSize(svg);
            if (!size) return;
            const root = document.documentElement;
            root.style.setProperty("--print-figure-width", size.width);
            root.style.setProperty("--print-figure-height", size.height);
        }

        function splitQuestionParts(questionHtml) {
            if (!questionHtml || typeof questionHtml !== "string") {
                return { stem: "", subs: [] };
            }
            const markerRegex = /[ï¼ˆ(]\d+[)ï¼‰]|[â‘ â‘¡â‘¢â‘£â‘¤â‘¥â‘¦â‘§â‘¨â‘©]/g;
            const matches = [...questionHtml.matchAll(markerRegex)];
            if (!matches.length) {
                return { stem: questionHtml, subs: [] };
            }
            const stem = questionHtml.slice(0, matches[0].index).trim();
            const subs = matches.map((match, idx) => {
                const start = match.index;
                const end = idx + 1 < matches.length ? matches[idx + 1].index : questionHtml.length;
                return questionHtml.slice(start, end).trim();
            }).filter(Boolean);
            return { stem, subs };
        }

        function formatQuestionForPrint(questionHtml) {
            const safeQuestion = sanitizeReadableText(questionHtml);
            const { stem, subs } = splitQuestionParts(safeQuestion);
            if (!subs.length) {
                return `<div class="math-content text-base text-justify print-q-text">${safeQuestion}</div>`;
            }
            let html = "";
            if (stem) {
                html += `<div class="math-content text-base text-justify print-q-text print-stem">${stem}</div>`;
            }
            subs.forEach((sub) => {
                html += `<div class="math-content text-base text-justify print-q-text print-subq">${sub}</div>`;
            });
            return html;
        }

        function getSvgComplexity(svg) {
            if (!svg || typeof svg !== "string") return "simple";
            const elementCount = (svg.match(/<\s*(path|rect|circle|ellipse|line|polyline|polygon|text|image)\b/gi) || []).length;
            const length = svg.length;
            if (elementCount >= 12 || length >= 1800) return "complex";
            return "simple";
        }

        function renderPrintContent(mode) {
            const container = document.getElementById('printVariations');
            container.innerHTML = ''; // Clear previous
            syncPrintFigureSize();
            let html = '';

            // ä½¿ç”¨å…¨å±€ currentVariations
            currentVariations.forEach((vType, vIndex) => {
                html += `
                    <div class="mb-4">
                        <h2 class="text-lg font-bold border-b-2 border-gray-800 mb-3 pb-1">${vType.type} - ${mode === 'answer' ? 'ç­”æ¡ˆè§£æ' : 'ä¸“é¡¹è®­ç»ƒ'}</h2>
                        <div class="grid grid-cols-1 gap-0">
                `;

                vType.items.forEach((item, i) => {
                    const safeQuestion = sanitizeReadableText(item.question);
                    const safeAnswer = sanitizeReadableText(item.answer);
                    const safeSolution = sanitizeReadableText(item.solution);
                    const safeSvg = sanitizeSvgMarkup(item.svg);
                    const hasSvg = Boolean(safeSvg);
                    const questionHtml = formatQuestionForPrint(item.question);
                    const complexity = getSvgComplexity(safeSvg);
                    html += `
                        <div class="print-question avoid-break ${hasSvg ? '' : 'no-figure'}">
                            <div class="print-q-row">
                                <span class="print-q-number text-base">${i + 1}.</span>
                                <div class="print-q-body">
                                    ${mode === 'question' ? `
                                        ${questionHtml}
                                        <div class="print-answer-area ${hasSvg ? '' : 'no-figure'}">
                                            <div class="print-answer-left">
                                                <div class="print-answer-lines"></div>
                                            </div>
                                            ${hasSvg ? `
                                                <div class="print-answer-right">
                                                    <div class="print-figure ${complexity === 'complex' ? 'is-complex' : ''}">${safeSvg}</div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    ` : `
                                        <div class="print-answer-block">
                                            <div class="mb-2 text-gray-800 font-bold math-content">å‚è€ƒç­”æ¡ˆï¼š${safeAnswer}</div>
                                            <div class="p-3 bg-gray-50 rounded border border-gray-200 text-sm math-content">
                                                <span class="font-bold block mb-1">è§£æï¼š</span>
                                                ${safeSolution}
                                            </div>
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `</div></div>`;
            });

            container.innerHTML = html;
            try {
                MathJax.typeset();
            } catch (e) {
                console.warn('MathJax æ¸²æŸ“å¼‚å¸¸', e);
            }
        }

        window.printQuestionVer = () => {
            renderPrintContent('question');
            setTimeout(() => window.print(), 300); // ç¨ç­‰æ¸²æŸ“
        };

        window.printAnswerVer = () => {
            renderPrintContent('answer');
            setTimeout(() => window.print(), 300);
        };

        // Drag & Drop & File Handling
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-indigo-400'); });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('border-indigo-400'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-indigo-400');
            handleFile(e.dataTransfer.files[0]);
        });

        // Click Upload is handled by onchange in HTML

        // Paste Upload
        document.addEventListener('paste', (e) => {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let item of items) {
                if (item.type.indexOf('image') !== -1) {
                    handleFile(item.getAsFile());
                    break;
                }
            }
        });

        function handleFile(file) {
            if (!file) return;
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶(JPG/PNG)');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => startAnalysis(e.target.result);
            reader.onerror = () => alert('æ–‡ä»¶è¯»å–å¤±è´¥');
            reader.readAsDataURL(file);
        }

        // æ¼”ç¤ºæ•°æ® Demo
        window.loadDemo = () => startAnalysis("DEMO_MODE");
        function getDemoData() {
            // è¿”å›ä¸€ä¸ªè¯­æ–‡ä½œæ–‡é€»è¾‘çš„Demo
            return {
                "subject": "å°å­¦è¯­æ–‡ Â· åˆ›æ„å†™ä½œ",
                "knowledge_point": "æ¯”å–»ä¸æ‹Ÿäººä¿®è¾æ‰‹æ³•çš„è¿ç”¨ï¼Œä»¥åŠâ€˜å€Ÿç‰©å–»äººâ€™çš„å†™ä½œé€»è¾‘ã€‚",
                "trap_analysis": "å­¦ç”Ÿå¸¸çŠ¯é”™è¯¯æ˜¯â€˜å–»ä½“ä¸å½“â€™ï¼Œå³æŠŠAæ¯”ä½œBæ—¶ï¼Œä¸¤è€…æ²¡æœ‰ç›¸ä¼¼ä¹‹å¤„ï¼›æˆ–è€…æ‹Ÿäººæ—¶åªèµ‹äºˆäº†åŠ¨ä½œï¼Œæ²¡æœ‰èµ‹äºˆäººçš„æƒ…æ„Ÿï¼Œå¯¼è‡´å¥å­å¹²ç˜ªï¼Œç¼ºä¹æ„ŸæŸ“åŠ›ã€‚",
                "variations": [
                    {
                        "type": "åŒç±»å·©å›ºï¼ˆä¿®è¾ä»¿å†™ï¼‰",
                        "items": Array(10).fill(0).map((_, i) => ({
                            "question": `è¯·ä»¿ç…§ä¾‹å¥ï¼Œç”¨â€œæ‹Ÿäººâ€çš„æ‰‹æ³•å†™ä¸€ä¸ªå…³äºâ€œ${['æ˜¥é£', 'å°æºª', 'é—¹é’Ÿ', 'ä¹¦åŒ…', 'å¤ªé˜³'][i % 5]}â€çš„å¥å­ã€‚ä¾‹ï¼šé¡½çš®çš„é›¨æ»´æœ€çˆ±åœ¨é›¨ä¼ä¸Šå°½æƒ…åœ°è·³èˆã€‚`,
                            "answer": "ç•¥",
                            "solution": "å…³é”®ç‚¹ï¼šèµ‹äºˆç‰©ä½“äººçš„åŠ¨ä½œæˆ–æƒ…æ„Ÿï¼ˆå¦‚å”±æ­Œã€ç¡è§‰ã€å¥”è·‘ï¼‰ã€‚"
                        }))
                    },
                    {
                        "type": "é€†å‘æ€ç»´ï¼ˆç—…å¥ä¿®æ”¹ï¼‰",
                        "items": Array(10).fill(0).map((_, i) => ({
                            "question": "åˆ¤æ–­ä¸‹åˆ—å¥å­ä¿®è¾ä½¿ç”¨æ˜¯å¦æ°å½“ï¼Œå¹¶ä¿®æ”¹ï¼šâ€˜å¤§æ ‘åƒä¸€ä¸ªå·¨å¤§çš„è˜‘è‡ï¼Œåœ¨å¤§å£°åœ°å”±æ­Œã€‚â€™",
                            "answer": "ä¸æ°å½“ã€‚å¤§æ ‘åƒè˜‘è‡æ˜¯æ¯”å–»å½¢çŠ¶ï¼Œå¤§å£°å”±æ­Œæ˜¯æ‹Ÿäººï¼Œé€»è¾‘ä¸é€šã€‚",
                            "solution": "ä¿®æ”¹ï¼šå¤§æ ‘åƒä¸€æŠŠå·¨å¤§çš„ç»¿ä¼ï¼Œä¸ºæˆ‘ä»¬é®æŒ¡çƒˆæ—¥ã€‚"
                        }))
                    },
                    {
                        "type": "ç»¼åˆæ‹“å±•ï¼ˆæƒ…æ™¯æå†™ï¼‰",
                        "items": Array(10).fill(0).map((_, i) => ({
                            "question": "è¿ç”¨æ¯”å–»å’Œæ’æ¯”çš„æ‰‹æ³•ï¼Œæå†™ä¸€æ®µå…³äºâ€˜æ ¡å›­è¿åŠ¨ä¼šâ€™çƒ­é—¹åœºæ™¯çš„æ–‡å­—ï¼ˆ50å­—å·¦å³ï¼‰ã€‚",
                            "answer": "ç•¥",
                            "solution": "è€ƒæ ¸ç»¼åˆè¿ç”¨èƒ½åŠ›ï¼Œæ³¨æ„å¥å¼æ•´é½å’Œç”»é¢æ„Ÿã€‚"
                        }))
                    }
                ]
            };
        }
    </script>
    <script src="../common/nav.js"></script>
</body>

</html>
